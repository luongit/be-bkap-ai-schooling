<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quên Mật Khẩu | Hệ Thống</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --accent: #f43f5e;
      --light: #f8fafc;
      --dark: #1e293b;
      --success: #10b981;
      --border: #e2e8f0;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
    body { background: linear-gradient(135deg,#f0f9ff,#e0f2fe); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; color: var(--dark);}
    .forgot-container { width:100%; max-width:440px; padding:40px; background:#fff; box-shadow:var(--shadow); border-radius:var(--radius); position:relative; overflow:hidden; transition:.3s; }
    .forgot-container:hover{ box-shadow:var(--shadow-hover);}
    .forgot-header{text-align:center; margin-bottom:30px;}
    .forgot-header h1{font-size:28px; font-weight:700; color:var(--primary); margin-bottom:10px;}
    .forgot-header p{color:var(--secondary); font-size:16px;}
    .step{display:none;} .step.active{display:block;}
    .input-group{margin-bottom:20px; position:relative;}
    label{display:block; margin-bottom:8px; font-weight:600; color:var(--dark); font-size:14px;}
    input{width:100%; padding:14px 16px; border:2px solid var(--border); background:var(--light); font-size:16px; border-radius:8px; transition:.3s;}
    input:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.15);}
    .password-toggle{position:absolute; right:15px; top:42px; color:var(--secondary); cursor:pointer;}
    button{width:100%; padding:14px; background:var(--primary); color:#fff; border:none; font-size:16px; font-weight:600; cursor:pointer; border-radius:8px; transition:.3s; margin-bottom:15px;}
    button:hover{background:var(--primary-dark); transform:translateY(-2px);}
    button:disabled{background:var(--secondary); cursor:not-allowed;}
    .back-link{display:block; text-align:center; margin-top:20px; color:var(--primary); font-weight:600; text-decoration:none;}
    .back-link:hover{text-decoration:underline;}
    .decoration{position:absolute; border-radius:50%; background:linear-gradient(135deg,rgba(37,99,235,0.1),rgba(37,99,235,0.05));}
    .decoration-1{width:200px; height:200px; top:-100px; right:-100px;}
    .decoration-2{width:160px; height:160px; bottom:-80px; left:-80px;}
    .toastify-custom{border-radius:8px; font-weight:600;}
  </style>
</head>
<body>
  <div class="forgot-container">
    <div class="decoration decoration-1"></div>
    <div class="decoration decoration-2"></div>
    <div class="forgot-header">
      <h1>Quên mật khẩu</h1>
      <p>Vui lòng làm theo các bước để khôi phục mật khẩu của bạn</p>
    </div>

    <!-- Bước 1 -->
    <div class="step active" id="step1">
      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="your@email.com">
      </div>
      <button id="sendOtpBtn">Gửi mã xác nhận</button>
    </div>

    <!-- Bước 2 -->
    <div class="step" id="step2">
      <div class="input-group">
        <label for="otp">Mã xác nhận (OTP)</label>
        <input type="text" id="otp" placeholder="Nhập mã OTP">
      </div>
      <button id="verifyOtpBtn">Xác nhận mã</button>
    </div>

    <!-- Bước 3 -->
    <div class="step" id="step3">
      <div class="input-group">
        <label for="newPassword">Mật khẩu mới</label>
        <input type="password" id="newPassword" placeholder="••••••••">
        <i class="fas fa-eye password-toggle" id="newPasswordToggle"></i>
      </div>
      <div class="input-group">
        <label for="confirmPassword">Xác nhận mật khẩu</label>
        <input type="password" id="confirmPassword" placeholder="••••••••">
        <i class="fas fa-eye password-toggle" id="confirmPasswordToggle"></i>
      </div>
      <button id="resetPasswordBtn">Đặt lại mật khẩu</button>
    </div>

    <a href="/auth/login" class="back-link">← Quay lại đăng nhập</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // Toggle mật khẩu
    function setupPasswordToggle(passwordId, toggleId) {
      document.getElementById(toggleId).addEventListener('click', function() {
        const input = document.getElementById(passwordId);
        if (input.type === 'password') {
          input.type = 'text';
          this.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
          input.type = 'password';
          this.classList.replace('fa-eye-slash', 'fa-eye');
        }
      });
    }
    setupPasswordToggle('newPassword', 'newPasswordToggle');
    setupPasswordToggle('confirmPassword', 'confirmPasswordToggle');

    // Toast helper
    function showToast(msg, type='success') {
      let bg = type==='error'
        ? 'linear-gradient(135deg,#f43f5e,#e11d48)'
        : type==='warning'
          ? 'linear-gradient(135deg,#f59e0b,#d97706)'
          : 'linear-gradient(135deg,#2563eb,#1d4ed8)';
      Toastify({ text: msg, duration: 3000, gravity:"top", position:"right", style:{background:bg} }).showToast();
    }

    function goToStep(n){ document.querySelectorAll('.step').forEach(s=>s.classList.remove('active')); document.getElementById('step'+n).classList.add('active'); }

    // Gửi OTP
    document.getElementById('sendOtpBtn').addEventListener('click', async function(){
      const email = document.getElementById('email').value.trim();
      if(!email) return showToast('Vui lòng nhập email','warning');
      this.innerHTML='<i class="fas fa-spinner fa-spin"></i> Đang gửi...'; this.disabled=true;
      try{
        const res = await fetch('/api/auth/forgot-password',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email})
        });
        if(!res.ok) throw new Error((await res.json()).message||'Không thể gửi OTP');
        showToast('Mã xác nhận đã gửi đến email!');
        goToStep(2);
      }catch(e){ showToast(e.message,'error'); }
      this.innerHTML='Gửi mã xác nhận'; this.disabled=false;
    });

    // Xác thực OTP
    document.getElementById('verifyOtpBtn').addEventListener('click', async function(){
      const otp=document.getElementById('otp').value.trim();
      if(!otp) return showToast('Vui lòng nhập mã','warning');
      this.innerHTML='<i class="fas fa-spinner fa-spin"></i> Đang xác nhận...'; this.disabled=true;
      try{
        const res = await fetch('/api/auth/verify-otp',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:otp})
        });
        if(!res.ok) throw new Error((await res.json()).message||'OTP không hợp lệ');
        showToast('Xác nhận thành công, hãy đặt mật khẩu mới!');
        goToStep(3);
      }catch(e){ showToast(e.message,'error'); }
      this.innerHTML='Xác nhận mã'; this.disabled=false;
    });

    // Đặt lại mật khẩu
    document.getElementById('resetPasswordBtn').addEventListener('click', async function(){
      const newPw=document.getElementById('newPassword').value, cf=document.getElementById('confirmPassword').value, otp=document.getElementById('otp').value;
      if(!newPw||!cf) return showToast('Điền đầy đủ thông tin','warning');
      if(newPw!==cf) return showToast('Mật khẩu không khớp','error');
      this.innerHTML='<i class="fas fa-spinner fa-spin"></i> Đang đặt lại...'; this.disabled=true;
      try{
        const res = await fetch('/api/auth/reset-password',{
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token:otp,newPassword:newPw})
        });
        if(!res.ok) throw new Error((await res.json()).message||'Không thể đặt lại mật khẩu');
        showToast('Đặt lại mật khẩu thành công! Đang chuyển hướng...');
        setTimeout(()=>window.location.href='/auth/login',1500);
      }catch(e){ showToast(e.message,'error'); this.innerHTML='Đặt lại mật khẩu'; this.disabled=false; }
    });

    // Enter để submit
    document.addEventListener('keypress', e=>{
      if(e.key==='Enter'){
        if(document.getElementById('step1').classList.contains('active')) document.getElementById('sendOtpBtn').click();
        else if(document.getElementById('step2').classList.contains('active')) document.getElementById('verifyOtpBtn').click();
        else if(document.getElementById('step3').classList.contains('active')) document.getElementById('resetPasswordBtn').click();
      }
    });
  </script>
</body>
</html>
