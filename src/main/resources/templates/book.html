<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Storybook AI</title>

<style>
body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
}
.container {
    max-width: 820px;
    margin: auto;
    background: #fff;
    padding: 22px;
    border-radius: 14px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}
h1 { text-align:center; }

textarea {
    width:100%;
    height:120px;
    font-size:16px;
    padding:12px;
    border-radius:10px;
}

.actions {
    text-align:center;
    margin:14px 0;
}
.actions button {
    padding:10px 18px;
    border:none;
    border-radius:10px;
    background:#4f46e5;
    color:#fff;
    cursor:pointer;
}
.actions button:disabled {
    background:#c7c7c7;
}

.status {
    text-align:center;
    font-weight:600;
    margin-bottom:10px;
}
.status.generating { color:#f59e0b; }
.status.completed { color:#16a34a; }
.status.failed { color:#dc2626; }
.status.draft { color:#6b7280; }

.story img {
    width:100%;
    max-height:420px;
    object-fit:contain;
    background:#eee;
    border-radius:10px;
}
.page-text {
    margin-top:15px;
    font-size:18px;
    line-height:1.6;
}
audio { width:100%; margin-top:12px; }

.controls {
    display:flex;
    justify-content:space-between;
    margin-top:16px;
}
</style>
</head>
<body>

<div class="container">
    <h1 id="title">Storybook AI</h1>

    <!-- CREATE -->
    <textarea id="prompt"
        placeholder="Nháº­p Ã½ tÆ°á»Ÿng truyá»‡n, vÃ­ dá»¥: Má»™t chÃº mÃ¨o nhá» khÃ¡m phÃ¡ khu rá»«ng tháº§n tiÃªn...">
    </textarea>

    <div class="actions">
        <button onclick="createStorybook()">âž• Táº¡o Storybook</button>
        <button id="generateBtn" onclick="generateStory()" disabled>âœ¨ Táº¡o truyá»‡n</button>
        <button id="exportBtn" onclick="exportPdf()" disabled>ðŸ“„ Export PDF</button>
    </div>

    <p id="desc" style="text-align:center;color:#666"></p>
    <div id="status" class="status"></div>

    <!-- VIEW -->
    <div class="story">
        <img id="img">
        <div id="text" class="page-text"></div>
        <audio id="audio" controls></audio>
    </div>

    <div class="controls">
        <button onclick="prev()">â¬… TrÆ°á»›c</button>
        <span id="indicator">0 / 0</span>
        <button onclick="next()">Sau âž¡</button>
    </div>
</div>

<script>
/* ===== CONFIG ===== */
const API = "http://localhost:8080/api/storybooks";

/* ===== STATE ===== */
let storybookId = null;
let pages = [];
let idx = 0;
let status = null;

/* ===== API ===== */
function api(url, opt = {}) {
    return fetch(url, {
        ...opt,
        headers: { "Content-Type": "application/json" }
    });
}

/* ===== CREATE ===== */
function createStorybook() {
    const prompt = document.getElementById("prompt").value.trim();
    if (!prompt) {
        alert("Nháº­p Ã½ tÆ°á»Ÿng truyá»‡n!");
        return;
    }

    api(API, {
        method: "POST",
        body: JSON.stringify({
            originalPrompt: prompt,

            // âœ… MODEL ÄÃšNG â€“ KHÃ”NG DÃ™NG 2.0
            textModel: "gemini-2.5-flash",
            imageModel: "gemini-2.5-flash-image",   // âœ… FIX 404 á»ž ÄÃ‚Y
            ttsModel: "gemini-2.5-flash-preview-tts"
        })
    })
    .then(r => r.json())
    .then(sb => {
        storybookId = sb.id;
        document.getElementById("title").innerText = "Storybook #" + sb.id;
        document.getElementById("generateBtn").disabled = false;
        renderStatus(sb.status);
        alert("ÄÃ£ táº¡o Storybook. Báº¥m 'Táº¡o truyá»‡n'.");
    })
    .catch(err => {
        console.error(err);
        alert("Lá»—i táº¡o storybook");
    });
}

/* ===== GENERATE ===== */
function generateStory() {
    if (!storybookId) return;

    api(`${API}/${storybookId}/generate`, { method:"POST" })
        .then(r => r.json())
        .then(res => {
            status = res.status;
            renderStatus(status);
            pollStatus();
        });
}

/* ===== STATUS POLLING ===== */
function pollStatus() {
    const timer = setInterval(() => {
        api(`${API}/${storybookId}/status`)
            .then(r => r.json())
            .then(res => {
                status = res.status;
                renderStatus(status);

                if (status === "COMPLETED" || status === "FAILED") {
                    clearInterval(timer);
                    if (status === "COMPLETED") {
                        document.getElementById("exportBtn").disabled = false;
                        loadPages();
                    }
                }
            });
    }, 3000);
}

/* ===== LOAD ===== */
function loadPages() {
    api(`${API}/${storybookId}/pages`)
        .then(r => r.json())
        .then(data => {
            pages = data || [];
            idx = 0;
            renderPage();
        });
}

/* ===== RENDER ===== */
function renderStatus(s) {
    const el = document.getElementById("status");
    el.innerText = "Tráº¡ng thÃ¡i: " + s;
    el.className = "status " + s.toLowerCase();
}

function renderPage() {
    if (!pages.length) return;
    const p = pages[idx];
    document.getElementById("img").src = p.imageUrl || "";
    document.getElementById("text").innerText = p.textContent || "";
    document.getElementById("audio").src = p.audioUrl || "";
    document.getElementById("indicator").innerText =
        `${idx + 1} / ${pages.length}`;
}

function prev(){ if(idx > 0){ idx--; renderPage(); } }
function next(){ if(idx < pages.length - 1){ idx++; renderPage(); } }

/* ===== EXPORT ===== */
function exportPdf() {
    api(`${API}/${storybookId}/export/pdf`, { method:"POST" })
        .then(r => r.text())
        .then(url => window.open(url));
}
</script>

</body>
</html>
